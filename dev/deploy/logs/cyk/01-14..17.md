# 22.01.14 ～ 22.01.17

> 本机部署测试，编写部署文档：考虑容器分离、保存镜像

## 部署文档

虚拟机问题解决，然后准备进入实战。

通过从零开始，重新完成了项目部署，并将具体过程记录在新的部署文档中。部署文档为[deploy/2021](/man/deploy/2021.md)，适用于上一届的项目。

接下来对一些部件进行测试，发现office较为麻烦，涉及到容器关系，于是开始系统性学习docker。

### docker学习

学习使用了容器、镜像。对镜像和容器有了进一步认识。

期间重装两次，前置的安装较为耗时。

### 组件互联

主要目的是解决OnlyOffice与系统的连接。参考资料为[上一届博客](https://blog.csdn.net/rentenglong2012)和seafile手册。其中主要额外附加的功能是

- OnlyOffice

    OnlyOffice特殊性在于它需要一个外置容器，而其他组件在本次部署中实际上是同一容器内的。解决与OnlyOffice的连接问题就能解决其他组件连接问题。

    参考[相关博客](https://blog.csdn.net/rentenglong2012/article/details/115957041?spm=1001.2014.3001.5502)，博客中使用方法为云服务器反响代理，而我的目的是本地LAN互联。

    于是学习docker网络，有了初步认识。偶然见发现ping能通过容器名与同一网络下的其他主机互联，于是测试用容器名替换localhost，结果失败。

    然后又通过ping发现docker容器也存在LAN的ip地址，于是使用该ip测试，然后成功。

- ElasticSearch

    在一开始的测试中，ElasticSearch尽管以按照要求配置，但似乎并没有工作。后来发现这是一个间隔10m的定时任务，第二天测试时阅读seafevents记录文件发现确实能正常工作。

- 杀毒

    通过seafevents记录文件可以看到这是一个几乎是触发式的事件，它能正常工作。

- 离线下载

    测试https协议，它能正常离线下载。

- 审计

    一开始不能工作。后来发现是配置文件中开关没有打开，打开后等待一天，能够工作。

### 配置play、容器分离

此次部署发现重点就在于配置文件上，主要包含两个部分：配置文件夹、环境变量。

一开始以为各个运行脚本的环境变量是重定义，会被覆盖，后来发现它们保持了一致性。主要包括`PYTHON_PATH`、`CCNET_CONFIG`和`SEAFILE_CONFIG`，它们在不同组件中都是相同的。

于是进一步学习容器修改端口的相关内容，然后改变端口映射，改变配置内容。结果与预想相同，随后得到容器化初步结论，并将分离方案写进了部署文档中。

### 保存镜像

按照docker中的基本操作，把上述结果持久化。最后的到了一个大小3G的镜像文件。这个文件代表的是一个阶段性成果，同时也是以备不时只需。